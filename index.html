<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è²“ã®é«”é‡ (è¨ºæ–·æ¨¡å¼)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@300;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg: #f9f8f6; --text-main: #464646; --primary: #78866b; }
        body { font-family: 'Noto Serif TC', serif; background-color: var(--bg); color: var(--text-main); padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 480px; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        /* è¨ºæ–·è¨Šæ¯å€ */
        #debug-console {
            background: #2d3436; color: #55efc4; font-family: monospace; 
            padding: 15px; border-radius: 8px; font-size: 0.85rem; 
            white-space: pre-wrap; margin-bottom: 20px; width: 100%; max-width: 480px;
            border: 2px solid #000;
        }
        .log-time { color: #aaa; margin-right: 5px; }
        .log-error { color: #ff7675; font-weight: bold; }
        .log-success { color: #ffeaa7; }
        
        /* éš±è—åŸæœ¬çš„ UIï¼Œç›´åˆ°è¼‰å…¥å®Œæˆ */
        .loading-box { text-align: center; padding: 40px; }
        
        /* ç°¡å–®æ¨£å¼ */
        input, button { width: 100%; padding: 10px; margin-top: 10px; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; cursor: pointer; }
        .tab-bar { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab { padding: 5px 10px; border-bottom: 2px solid transparent; cursor: pointer; }
        .tab.active { border-color: var(--primary); font-weight: bold; }
        .list-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed #ccc; }
        img.avatar { width: 40px; height: 40px; border-radius: 50%; vertical-align: middle; margin-right: 10px; }
    </style>
</head>
<body>

<h3>è¨ºæ–·ç´€éŒ„ (Debug Log)</h3>
<div id="debug-console">ç³»çµ±åˆå§‹åŒ–ä¸­...</div>

<div id="app" class="container">
    <h1>è²“ã®é«”é‡</h1>

    <div v-if="loading" class="loading-box">
        è®€å–ä¸­...<br>
        <small>è«‹æŸ¥çœ‹ä¸Šæ–¹çš„é»‘è‰²è¨ºæ–·æ¡†</small>
    </div>

    <div v-else>
        <div class="tab-bar">
            <div class="tab" @click="tab='record'" :class="{active: tab==='record'}">è¨˜éŒ„</div>
            <div class="tab" @click="tab='chart'" :class="{active: tab==='chart'}">è¶¨å‹¢</div>
            <div class="tab" @click="tab='settings'" :class="{active: tab==='settings'}">è¨­å®š</div>
        </div>

        <div v-if="tab==='record'" class="card">
            <div v-if="cats.length===0">è«‹å…ˆå»è¨­å®šé æ–°å¢è²“å’ª</div>
            <div v-else>
                <select v-model="entry.catId" style="padding:10px; width:100%;">
                    <option v-for="c in cats" :value="c.id">{{c.name}}</option>
                </select>
                <input type="date" v-model="entry.date">
                <input type="number" v-model.number="entry.weight" placeholder="é«”é‡ (kg)">
                <button @click="addRecord">é€å‡º</button>
            </div>
            <div v-for="r in records.slice(0,5)" class="list-item">
                <span>{{r.date}}</span> <span>{{getCatName(r.catId)}}: {{r.weight}}kg</span>
            </div>
        </div>

        <div v-if="tab==='chart'" class="card">
            <canvas id="chart"></canvas>
        </div>

        <div v-if="tab==='settings'" class="card">
            <input v-model="newCat" placeholder="è²“å’ªåå­—">
            <button @click="addCat">æ–°å¢è²“å’ª</button>
            <div v-for="c in cats" class="list-item">
                <span>{{c.name}}</span> <button style="width:auto; padding:2px 8px; background:#ccc;" @click="delCat(c.id)">åˆª</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- è¨ºæ–·å·¥å…· ---
    function log(msg, type = 'info') {
        const consoleDiv = document.getElementById('debug-console');
        const time = new Date().toLocaleTimeString();
        let colorClass = '';
        if(type === 'error') colorClass = 'log-error';
        if(type === 'success') colorClass = 'log-success';
        
        consoleDiv.innerHTML += `\n<span class="log-time">[${time}]</span> <span class="${colorClass}">${msg}</span>`;
        consoleDiv.scrollTop = consoleDiv.scrollHeight;
        console.log(`[${type}] ${msg}`);
    }

    // æ•æ‰å…¨åŸŸéŒ¯èª¤
    window.onerror = function(message, source, lineno, colno, error) {
        log(`å…¨åŸŸéŒ¯èª¤: ${message}`, 'error');
    };

    // --- Firebase è¨­å®š ---
    const firebaseConfig = {
      apiKey: "AIzaSyB62SzNqiusoXCbCpDHS1vCiuS70ZHVDUE",
      authDomain: "catweight-d4888.firebaseapp.com",
      databaseURL: "https://catweight-d4888-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "catweight-d4888",
      storageBucket: "catweight-d4888.firebasestorage.app",
      messagingSenderId: "527733046362",
      appId: "1:527733046362:web:d1bd552108e6c03f8d6c63"
    };

    log("1. æ­£åœ¨è¼‰å…¥ Firebase...");

    try {
        if (!firebase) throw new Error("Firebase SDK æœªè¼‰å…¥");
        firebase.initializeApp(firebaseConfig);
        log("2. Firebase åˆå§‹åŒ–æˆåŠŸ", 'success');
        
        const db = firebase.database();
        log(`3. è³‡æ–™åº« URL: ${firebaseConfig.databaseURL}`);
        log("4. å˜—è©¦é€£ç·šåˆ°è³‡æ–™åº«...");

        // æ¸¬è©¦é€£ç·šç‹€æ…‹
        const connectedRef = db.ref(".info/connected");
        connectedRef.on("value", (snap) => {
            if (snap.val() === true) {
                log("âœ… ç¶²è·¯é€£ç·šå·²å»ºç«‹ (Connected)", 'success');
            } else {
                log("â³ æ­£åœ¨å»ºç«‹é€£ç·š... (è‹¥å¡ä½å¤ªä¹…å¯èƒ½æ˜¯è¢«é˜²ç«ç‰†æ“‹ä½)");
            }
        });

        const { createApp, ref, onMounted, watch, nextTick } = Vue;

        createApp({
            setup() {
                const loading = ref(true);
                const tab = ref('record');
                const cats = ref([]);
                const records = ref([]);
                const entry = ref({catId:'', date: new Date().toISOString().split('T')[0], weight:''});
                const newCat = ref('');
                let chartInstance = null;

                onMounted(() => {
                    log("5. Vue å·²æ›è¼‰ï¼Œé–‹å§‹è®€å–è³‡æ–™...");
                    
                    // è®€å–è²“å’ª
                    db.ref('cats').on('value', (snap) => {
                        log(`ğŸ“¥ æ”¶åˆ°è²“å’ªè³‡æ–™ (ç­†æ•¸: ${snap.numChildren()})`, 'success');
                        const val = snap.val();
                        cats.value = val ? Object.entries(val).map(([k,v])=>({id:k, ...v})) : [];
                        if(cats.value.length && !entry.value.catId) entry.value.catId = cats.value[0].id;
                        loading.value = false; // åªè¦æœ‰å›å‚³ï¼Œå°±é—œé–‰ loading
                    }, (err) => {
                        log(`âŒ è®€å–è²“å’ªå¤±æ•—: ${err.message}`, 'error');
                        if(err.code === 'PERMISSION_DENIED') log("ğŸ‘‰ è«‹æª¢æŸ¥ Firebase Console è¦å‰‡æ˜¯å¦è¨­ç‚º true", 'error');
                    });

                    // è®€å–ç´€éŒ„
                    db.ref('records').on('value', (snap) => {
                        const val = snap.val();
                        records.value = val ? Object.entries(val).map(([k,v])=>({id:k, ...v})).sort((a,b)=>new Date(a.date)-new Date(b.date)) : [];
                        if(tab.value === 'chart') renderChart();
                    });
                });

                const addCat = () => {
                    if(!newCat.value) return;
                    db.ref('cats').push({name: newCat.value}).then(()=>{
                        log("æ–°å¢è²“å’ªæˆåŠŸ", 'success');
                        newCat.value='';
                    }).catch(e => log(`æ–°å¢å¤±æ•—: ${e.message}`, 'error'));
                };

                const delCat = (id) => {
                    if(confirm('åˆªé™¤?')) db.ref(`cats/${id}`).remove();
                };

                const addRecord = () => {
                    if(!entry.value.weight) return;
                    db.ref('records').push(entry.value).then(()=>{
                        alert('OK'); entry.value.weight='';
                    }).catch(e => log(`ç´€éŒ„å¤±æ•—: ${e.message}`, 'error'));
                };

                const getCatName = (id) => cats.value.find(c=>c.id===id)?.name;

                watch(tab, (v) => { if(v==='chart') nextTick(renderChart); });

                const renderChart = () => {
                    const ctx = document.getElementById('chart');
                    if(!ctx) return;
                    if(chartInstance) chartInstance.destroy();
                    const dates = [...new Set(records.value.map(r=>r.date))];
                    const datasets = cats.value.map(c => ({
                        label: c.name,
                        borderColor: '#78866b',
                        data: dates.map(d => records.value.find(r=>r.date===d && r.catId===c.id)?.weight || null),
                        spanGaps: true
                    }));
                    chartInstance = new Chart(ctx, {type:'line', data:{labels:dates, datasets}});
                };

                return { loading, tab, cats, records, entry, newCat, addCat, delCat, addRecord, getCatName };
            }
        }).mount('#app');

    } catch (e) {
        log(`ç³»çµ±åš´é‡éŒ¯èª¤: ${e.message}`, 'error');
    }
</script>
</body>
</html>
