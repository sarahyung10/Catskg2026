<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è²“ã®é«”é‡</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <script>window.onerror = function(msg, url, line) { console.error("éŒ¯èª¤:", msg); };</script>

    <style>
        :root {
            --bg: #f9f8f6;       
            --card: #ffffff;
            --text-main: #464646;
            --text-light: #888888;
            --primary: #78866b;
            --danger: #d68c85;
            --border: #e8e8e6;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Noto Serif TC', serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 20px 10px;
            display: flex;
            justify-content: center;
            line-height: 1.6;
        }

        .container { width: 100%; max-width: 480px; }

        h1 {
            font-weight: 700; text-align: center; margin-bottom: 25px; letter-spacing: 0.1em;
            color: var(--text-main); font-size: 1.5rem; position: relative;
        }
        h1::after {
            content: ''; display: block; width: 30px; height: 2px;
            background: #b0aaa0; margin: 8px auto 0;
        }

        .card {
            background: var(--card); padding: 25px; margin-bottom: 20px;
            border: 1px solid var(--border); border-radius: 8px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.03);
        }

        .loading-box { text-align: center; color: #999; margin-top: 50px; font-size: 0.9rem; }

        /* --- åœ“å½¢å¤§é ­è²¼ --- */
        .avatar-selector { display: flex; justify-content: center; gap: 18px; margin-bottom: 25px; flex-wrap: wrap; }
        .avatar-option { display: flex; flex-direction: column; align-items: center; cursor: pointer; opacity: 0.5; transition: all 0.3s ease; }
        .avatar-option.selected { opacity: 1; transform: translateY(-3px); }
        .avatar-img {
            width: 65px; height: 65px; border-radius: 50%; object-fit: cover; 
            border: 3px solid #eee; padding: 2px; background: white; 
            transition: border-color 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .avatar-name { font-size: 0.85rem; margin-top: 8px; letter-spacing: 0.05em; font-weight: bold; }

        /* è¼¸å…¥æ¡† */
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 6px; font-size: 0.8rem; color: var(--text-light); letter-spacing: 0.05em; }
        input[type="text"], input[type="number"], input[type="date"] {
            width: 100%; padding: 10px 0; border: none; border-bottom: 1px solid #ccc;
            background: transparent; font-family: 'Noto Serif TC', serif; font-size: 1.1rem; 
            color: var(--text-main); border-radius: 0; outline: none; transition: border-color 0.3s;
        }
        input:focus { border-bottom-color: var(--primary); }

        button.btn-main {
            width: 100%; padding: 12px; border: none; background-color: var(--primary); color: white;
            font-family: 'Noto Serif TC', serif; font-size: 1rem; letter-spacing: 0.1em;
            cursor: pointer; transition: opacity 0.3s; border-radius: 4px; margin-top: 10px;
        }
        button.btn-cancel {
            width: 100%; padding: 10px; border: none; background: transparent; color: #999;
            margin-top: 5px; cursor: pointer; font-size: 0.85rem;
        }
        
        .upload-area {
            border: 1px dashed #b0aaa0; padding: 15px; text-align: center; margin-top: 10px; 
            cursor: pointer; color: var(--text-light); font-size: 0.85rem; border-radius: 4px;
        }
        .preview-avatar { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin: 15px auto; display: block; border: 4px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        /* åˆ—è¡¨æ¨£å¼ */
        .list-group-header {
            display: flex; align-items: center; border-bottom: 1px solid #eee; 
            padding-bottom: 10px; margin-bottom: 5px; margin-top: 10px;
        }
        .list-header-avatar { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-right: 10px; }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px dashed #eee; }
        .list-left { display: flex; align-items: center; gap: 15px; }
        .list-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid #eee; }
        .list-date { font-size: 0.85rem; color: var(--text-main); letter-spacing: 0.05em; }
        .list-weight { font-family: 'Noto Serif TC'; font-weight: 700; font-size: 1.1rem; color: var(--primary); }
        .list-actions { display: flex; align-items: center; gap: 8px; }

        .tabs { display: flex; justify-content: center; margin-bottom: 30px; gap: 25px; }
        .tab { cursor: pointer; color: var(--text-light); padding-bottom: 5px; font-size: 0.95rem; letter-spacing: 0.1em; position: relative; transition: color 0.3s; }
        .tab.active { color: var(--text-main); font-weight: bold; }
        .tab.active::after { content: ''; position: absolute; bottom: -2px; left: 0; width: 100%; height: 2px; background: var(--primary); }

        .btn-icon { background: none; border: none; color: #ccc; cursor: pointer; padding: 5px; font-size: 1.1rem; }
        .btn-icon:hover { color: var(--text-main); }
        
        .alert-box { background: #fff; border: 1px solid var(--danger); color: var(--danger); padding: 12px; margin-bottom: 20px; font-size: 0.85rem; display: flex; align-items: center; gap: 10px; border-radius: 4px; }

        /* --- ğŸ”¥ è¶…æ˜é¡¯åœ–è¡¨åœ–ä¾‹ --- */
        .chart-legend-container {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; 
            margin-bottom: 20px; padding: 15px; background: #fff; border-radius: 8px;
            border: 1px dashed #eee;
        }
        .legend-pill {
            display: flex; align-items: center; background: white; 
            padding: 6px 15px 6px 6px; border-radius: 50px; 
            box-shadow: 0 3px 8px rgba(0,0,0,0.05); cursor: pointer;
            transition: all 0.2s; 
            /* é€™è£¡æœƒå‹•æ…‹åŠ ä¸Šé‚Šæ¡†é¡è‰² */
        }
        .legend-pill:active { transform: scale(0.95); }
        .legend-pill.hidden { opacity: 0.3; box-shadow: none; background: #f0f0f0; border-color: #ddd !important; filter: grayscale(100%); }
        
        .legend-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; margin-right: 10px; }
        .legend-dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 8px; display:inline-block; }
        .legend-name { font-size: 0.9rem; font-weight: 900; letter-spacing: 0.05em; }

        /* è£åˆ‡è¦–çª— */
        .crop-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .crop-area-wrapper { width: 280px; height: 280px; border: 1px solid #ddd; position: relative; overflow: hidden; background: #eee; border-radius: 4px; touch-action: none; cursor: move; box-shadow: inset 0 0 20px rgba(0,0,0,0.05); }
        .crop-mask { pointer-events: none; position: absolute; top: 0; left: 0; bottom: 0; right: 0; border-radius: 50%; box-shadow: 0 0 0 300px rgba(255,255,255,0.8); border: 2px solid #666; z-index: 10; }
        .crop-img { position: absolute; transform-origin: 0 0; max-width: none; display: block; }
        .crop-controls { width: 280px; margin-top: 25px; display: flex; flex-direction: column; gap: 15px; }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #666; cursor: pointer; margin-top: -8px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #ddd; border-radius: 2px; }
        .crop-btns { display: flex; gap: 15px; margin-top: 10px; }
        .crop-btn { flex: 1; padding: 12px; border: 1px solid var(--text-main); background: transparent; cursor: pointer; letter-spacing: 1px; font-size: 0.9rem; }
        .crop-btn.confirm { background: var(--text-main); color: white; border: none; }
    </style>
</head>
<body>

<div id="app" class="container">
    <h1>è²“ã®é«”é‡</h1>

    <div v-if="loading" class="loading-box">è®€å–ä¸­...<br><small>é€£ç·šä¸­</small></div>

    <div v-else>
        <div class="tabs">
            <div class="tab" :class="{ active: currentTab === 'record' }" @click="currentTab = 'record'">è¨˜éŒ²</div>
            <div class="tab" :class="{ active: currentTab === 'chart' }" @click="currentTab = 'chart'">è¶¨å‹¢</div>
            <div class="tab" :class="{ active: currentTab === 'settings' }" @click="currentTab = 'settings'">è¨­å®š</div>
        </div>

        <div v-show="currentTab === 'record'">
            <div class="card">
                <div style="text-align:center; margin-bottom:15px; font-weight:bold; color:var(--edit-color);" v-if="editingRecordId">âœ ç·¨è¼¯æ¨¡å¼</div>
                <div v-if="healthAlert" class="alert-box"><span>âš ï¸</span> {{ healthAlert }}</div>
                
                <div v-if="cats.length === 0" style="text-align:center; color:#999; padding:20px;">è«‹å…ˆè‡³ã€Œè¨­å®šã€æ–°å¢è²“å’ª</div>
                <div v-else>
                    <div class="avatar-selector">
                        <div v-for="cat in cats" :key="cat.id" 
                             class="avatar-option" :class="{ selected: newEntry.catId === cat.id }"
                             @click="newEntry.catId = cat.id">
                            <img :src="cat.avatar || defaultAvatar" class="avatar-img" 
                                 :style="{ borderColor: newEntry.catId === cat.id ? cat.color : '#eee' }">
                            <span class="avatar-name" :style="{ color: newEntry.catId === cat.id ? cat.color : '' }">{{ cat.name }}</span>
                        </div>
                    </div>
                    <div class="form-group"><label>æ—¥æœŸ Date</label><input type="date" v-model="newEntry.date"></div>
                    <div class="form-group"><label>é«”é‡ Weight (kg)</label><input type="number" step="0.01" inputmode="decimal" v-model.number="newEntry.weight" placeholder="0.00"></div>
                    
                    <button class="btn-main" @click="saveRecord" :style="{ backgroundColor: editingRecordId ? '#54a0ff' : getSelectedCatColor }">
                        {{ editingRecordId ? 'æ›´æ–°ç´€éŒ„' : 'å„²å­˜ç´€éŒ„' }}
                    </button>
                    <button v-if="editingRecordId" class="btn-cancel" @click="cancelRecordEdit">å–æ¶ˆç·¨è¼¯</button>
                </div>
            </div>
            
            <div v-if="records.length > 0">
                <div style="font-size:0.75rem; color:#aaa; text-align:center; margin-bottom:10px; letter-spacing:1px;">HISTORY</div>
                
                <div class="card" style="padding: 15px;">
                    <div class="history-filters">
                        <div class="filter-chip" :class="{active: historyFilter === 'all'}" @click="setHistoryFilter('all')">å…¨éƒ¨</div>
                        <div v-for="cat in cats" :key="cat.id" 
                             class="filter-chip" :class="{active: historyFilter === cat.id}" 
                             @click="setHistoryFilter(cat.id)">
                            {{ cat.name }}
                        </div>
                    </div>

                    <div v-if="paginatedRecords.length === 0" style="text-align:center; padding:20px; color:#ccc;">ç„¡ç´€éŒ„</div>
                    <div v-for="rec in paginatedRecords" :key="rec.id" class="list-item">
                        <div class="list-left">
                            <img :src="getCatAvatar(rec.catId)" class="list-avatar">
                            <div>
                                <span class="list-date">{{ formatDate(rec.date) }}</span>
                                <span style="font-size:0.9rem; font-weight:bold; color:#555;">{{ getCatName(rec.catId) }}</span>
                            </div>
                        </div>
                        <div class="list-actions">
                            <span class="list-weight" :style="{ color: getCatColor(rec.catId) }">{{ rec.weight }}</span>
                            <button class="btn-icon" @click="editRecord(rec)">âœ</button>
                            <button class="btn-icon" @click="deleteRecord(rec.id)">âœ•</button>
                        </div>
                    </div>

                    <div class="pagination" v-if="totalPages > 1">
                        <button class="page-btn" :disabled="historyPage === 1" @click="historyPage--">â† ä¸Šä¸€é </button>
                        <span style="font-size:0.8rem; color:#888;">{{ historyPage }} / {{ totalPages }}</span>
                        <button class="page-btn" :disabled="historyPage === totalPages" @click="historyPage++">ä¸‹ä¸€é  â†’</button>
                    </div>
                </div>
            </div>
        </div>

        <div v-show="currentTab === 'chart'">
            <div class="card">
                <div class="chart-legend-container">
                    <div v-for="(cat, index) in cats" :key="cat.id" 
                         class="legend-pill" 
                         :class="{ hidden: isDatasetHidden(index) }"
                         :style="{ border: '2px solid ' + cat.color }"
                         @click="toggleDataset(index)">
                        <img :src="cat.avatar || defaultAvatar" class="legend-avatar">
                        <span class="legend-dot" :style="{ backgroundColor: cat.color }"></span>
                        <span class="legend-name" :style="{ color: cat.color }">{{ cat.name }}</span>
                    </div>
                </div>
                
                <div style="height: 300px; width: 100%;"><canvas id="weightChart"></canvas></div>
            </div>
        </div>

        <div v-show="currentTab === 'settings'">
            <div class="card">
                <div style="text-align:center; margin-bottom:20px; font-weight:bold;">{{ isEditing ? 'ç·¨è¼¯è³‡æ–™' : 'æ–°å¢è²“å’ª' }}</div>
                <div class="form-group" style="text-align:center;">
                    <img v-if="newCatData.avatarPreview" :src="newCatData.avatarPreview" class="preview-avatar">
                    <img v-else :src="defaultAvatar" class="preview-avatar" style="opacity:0.3;">
                    <div class="upload-area" @click="triggerUpload">{{ newCatData.avatarPreview ? 'æ›´æ›ç…§ç‰‡' : 'é»æ­¤ä¸Šå‚³ç…§ç‰‡' }}</div>
                    <input type="file" ref="fileInput" @change="onFileSelect" accept="image/*" style="display:none;">
                </div>
                <div class="form-group"><label>åå­— Name</label><input type="text" v-model="newCatData.name" placeholder="è¼¸å…¥è²“å’ªåå­—..." @keyup.enter="saveCat"></div>
                <button class="btn-main" @click="saveCat" :style="{background: isEditing ? '#54a0ff' : ''}">{{ isEditing ? 'æ›´æ–°è³‡æ–™' : 'æ–°å¢è²“å’ª' }}</button>
                <button v-if="isEditing" @click="cancelEdit" class="btn-cancel">å–æ¶ˆç·¨è¼¯</button>
            </div>
            
            <div class="card" v-if="cats.length > 0" style="padding: 10px 20px;">
                <div v-for="cat in cats" :key="cat.id" class="list-item">
                    <div class="list-left">
                        <img :src="cat.avatar || defaultAvatar" class="list-avatar" :style="{ border: '2px solid ' + cat.color }">
                        <span style="font-weight:bold; color:#555;">{{ cat.name }}</span>
                    </div>
                    <div><button class="btn-icon" @click="editCat(cat)">âœ</button><button class="btn-icon" @click="removeCat(cat.id)">âœ•</button></div>
                </div>
            </div>
        </div>
    </div>

    <div v-if="showCropper" class="crop-modal">
        <div class="crop-area-wrapper" 
             @mousedown="startDrag" @mousemove="onDrag" @mouseup="stopDrag" @mouseleave="stopDrag"
             @touchstart="startDrag" @touchmove="onDrag" @touchend="stopDrag">
            <img ref="cropImg" :src="cropper.imgSrc" class="crop-img" :style="cropStyle" @load="onImgLoad">
            <div class="crop-mask"></div>
        </div>
        <div class="crop-controls">
            <div class="zoom-label">èª¿æ•´ç¸®æ”¾èˆ‡ä½ç½®</div>
            <input type="range" min="0.1" max="3" step="0.05" v-model.number="cropper.userScale" class="zoom-range">
            <div class="crop-btns">
                <button class="crop-btn" @click="cancelCrop">å–æ¶ˆ</button>
                <button class="crop-btn confirm" @click="confirmCrop">å®Œæˆ</button>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

    const firebaseConfig = {
      apiKey: "AIzaSyB62SzNqiusoXCbCpDHS1vCiuS70ZHVDUE",
      authDomain: "catweight-d4888.firebaseapp.com",
      databaseURL: "https://catweight-d4888-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "catweight-d4888",
      storageBucket: "catweight-d4888.firebasestorage.app",
      messagingSenderId: "527733046362",
      appId: "1:527733046362:web:d1bd552108e6c03f8d6c63"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    createApp({
        setup() {
            const currentTab = ref('record');
            const cats = ref([]);
            const records = ref([]);
            const loading = ref(true);
            const healthAlert = ref('');
            const fileInput = ref(null);
            const defaultAvatar = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23e0e0e0'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z'/%3E%3C/svg%3E";

            const newEntry = ref({ catId: '', date: new Date().toISOString().split('T')[0], weight: '' });
            const editingRecordId = ref(null);
            
            // åˆ†é èˆ‡ç¯©é¸ç›¸é—œ State
            const historyFilter = ref('all');
            const historyPage = ref(1);
            const itemsPerPage = 5;

            const newCatData = ref({ name: '', avatarPreview: null, avatarBase64: null });
            const editingCatId = ref(null);
            const isEditing = computed(() => editingCatId.value !== null);
            const hiddenDatasets = ref({});
            let chartInstance = null;

            const colors = ['#3498db', '#e67e22', '#2ecc71', '#9b59b6', '#e74c3c', '#1abc9c', '#f1c40f'];
            const showCropper = ref(false);
            const cropImg = ref(null);
            const cropper = ref({ imgSrc: '', baseScale: 1, userScale: 1, x: 0, y: 0, isDragging: false, startX: 0, startY: 0, lastX: 0, lastY: 0 });

            setTimeout(() => { if(loading.value) loading.value = false; }, 3000);

            onMounted(() => {
                db.ref('cats').on('value', snap => {
                    const val = snap.val();
                    cats.value = val ? Object.entries(val).map(([k,v]) => ({id:k, ...v})) : [];
                    if(cats.value.length && !newEntry.value.catId && !editingRecordId.value) newEntry.value.catId = cats.value[0].id;
                    loading.value = false;
                    if(currentTab.value === 'chart') renderChart();
                });
                db.ref('records').on('value', snap => {
                    const val = snap.val();
                    records.value = val ? Object.entries(val).map(([k,v]) => ({id:k, ...v})).sort((a,b)=>new Date(a.date)-new Date(b.date)) : [];
                    if(currentTab.value === 'chart') renderChart();
                });
            });

            // æ­·å²ç´€éŒ„ç¯©é¸èˆ‡åˆ†é é‚è¼¯
            const setHistoryFilter = (id) => {
                historyFilter.value = id;
                historyPage.value = 1; // åˆ‡æ›ç¯©é¸æ™‚å›åˆ°ç¬¬ä¸€é 
            };

            const filteredRecords = computed(() => {
                let sorted = [...records.value].sort((a,b) => new Date(b.date) - new Date(a.date)); // æ—¥æœŸæ–°->èˆŠ
                if (historyFilter.value !== 'all') {
                    sorted = sorted.filter(r => r.catId === historyFilter.value);
                }
                return sorted;
            });

            const totalPages = computed(() => Math.ceil(filteredRecords.value.length / itemsPerPage));

            const paginatedRecords = computed(() => {
                const start = (historyPage.value - 1) * itemsPerPage;
                const end = start + itemsPerPage;
                return filteredRecords.value.slice(start, end);
            });

            const triggerUpload = () => fileInput.value.click();
            const onFileSelect = (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (evt) => { cropper.value = { imgSrc: evt.target.result, baseScale: 1, userScale: 1, x: 0, y: 0, isDragging: false, startX: 0, startY: 0, lastX: 0, lastY: 0 }; showCropper.value = true; e.target.value = ''; }; reader.readAsDataURL(file); };
            const onImgLoad = (e) => { const img = e.target; const ratio = 280 / Math.min(img.naturalWidth, img.naturalHeight); cropper.value.baseScale = ratio; cropper.value.userScale = 1; cropper.value.x = (280 - img.naturalWidth * ratio) / 2; cropper.value.y = (280 - img.naturalHeight * ratio) / 2; cropper.value.lastX = cropper.value.x; cropper.value.lastY = cropper.value.y; };
            const finalScale = computed(() => cropper.value.baseScale * cropper.value.userScale);
            const cropStyle = computed(() => ({ transform: `translate(${cropper.value.x}px, ${cropper.value.y}px) scale(${finalScale.value})` }));
            const getClientPos = (e) => e.touches ? { x: e.touches[0].clientX, y: e.touches[0].clientY } : { x: e.clientX, y: e.clientY };
            const startDrag = (e) => { cropper.value.isDragging = true; const pos = getClientPos(e); cropper.value.startX = pos.x; cropper.value.startY = pos.y; };
            const onDrag = (e) => { if (!cropper.value.isDragging) return; e.preventDefault(); const pos = getClientPos(e); cropper.value.x = cropper.value.lastX + (pos.x - cropper.value.startX); cropper.value.y = cropper.value.lastY + (pos.y - cropper.value.startY); };
            const stopDrag = () => { cropper.value.isDragging = false; cropper.value.lastX = cropper.value.x; cropper.value.lastY = cropper.value.y; };
            const confirmCrop = () => { const cvs = document.createElement('canvas'); const ctx = cvs.getContext('2d'); cvs.width = 200; cvs.height = 200; ctx.fillStyle = "#fff"; ctx.fillRect(0, 0, 200, 200); const ratio = 200/280; ctx.save(); ctx.scale(ratio, ratio); ctx.translate(cropper.value.x, cropper.value.y); ctx.scale(finalScale.value, finalScale.value); ctx.drawImage(cropImg.value, 0, 0); ctx.restore(); newCatData.value.avatarPreview = cvs.toDataURL('image/jpeg', 0.85); newCatData.value.avatarBase64 = newCatData.value.avatarPreview; showCropper.value = false; };
            const cancelCrop = () => showCropper.value = false;
            
            const getCatName = (id) => cats.value.find(c => c.id === id)?.name;
            const getCatAvatar = (id) => cats.value.find(c => c.id === id)?.avatar || defaultAvatar;
            const getCatColor = (id) => cats.value.find(c => c.id === id)?.color || '#ccc';
            const getSelectedCatColor = computed(() => getCatColor(newEntry.value.catId));
            const formatDate = (s) => s.replace(/-/g, '.');

            const editCat = (cat) => { editingCatId.value = cat.id; newCatData.value = { name: cat.name, avatarPreview: cat.avatar, avatarBase64: cat.avatar }; window.scrollTo({ top: 0, behavior: 'smooth' }); };
            const cancelEdit = () => { editingCatId.value = null; newCatData.value = { name: '', avatarPreview: null, avatarBase64: null }; };
            const saveCat = () => { if(!newCatData.value.name.trim()) return alert('è«‹è¼¸å…¥åå­—'); const payload = { name: newCatData.value.name, avatar: newCatData.value.avatarBase64 || null }; if(isEditing.value) db.ref(`cats/${editingCatId.value}`).update(payload).then(()=>{ cancelEdit(); alert('å·²æ›´æ–°'); }); else { payload.color = colors[cats.value.length % colors.length]; db.ref('cats').push(payload).then(()=>{ cancelEdit(); alert('å·²æ–°å¢'); }); } };
            const removeCat = (id) => confirm('åˆªé™¤å¾Œç„¡æ³•å¾©åŸï¼Œç¢ºå®šï¼Ÿ') && db.ref(`cats/${id}`).remove();

            const editRecord = (rec) => { editingRecordId.value = rec.id; newEntry.value = { catId: rec.catId, date: rec.date, weight: rec.weight }; window.scrollTo({ top: 0, behavior: 'smooth' }); };
            const cancelRecordEdit = () => { editingRecordId.value = null; newEntry.value = { catId: cats.value.length ? cats.value[0].id : '', date: new Date().toISOString().split('T')[0], weight: '' }; healthAlert.value = ''; };
            const deleteRecord = (id) => confirm('åˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ') && db.ref(`records/${id}`).remove();
            
            const saveRecord = () => {
                if(!newEntry.value.catId || !newEntry.value.weight) return alert('è³‡æ–™ä¸å…¨');
                const inputDate = new Date(newEntry.value.date);
                const inputWeight = parseFloat(newEntry.value.weight);
                const catRecs = records.value.filter(r => r.catId === newEntry.value.catId && r.id !== editingRecordId.value).sort((a, b) => new Date(a.date) - new Date(b.date));
                if(catRecs.length > 0) {
                    const last = catRecs[catRecs.length - 1];
                    if (inputDate >= new Date(last.date)) {
                        const diff = inputWeight - last.weight;
                        healthAlert.value = (Math.abs(diff)/last.weight >= 0.05) ? `æ³¨æ„ï¼š${getCatName(newEntry.value.catId)} é«”é‡è®ŠåŒ– ${(diff>0?'+':'')}${diff.toFixed(2)}kg` : '';
                    } else healthAlert.value = '';
                }
                if (editingRecordId.value) { db.ref(`records/${editingRecordId.value}`).update({ catId: newEntry.value.catId, date: newEntry.value.date, weight: inputWeight }).then(()=>{ alert('å·²æ›´æ–°'); cancelRecordEdit(); }); }
                else { db.ref('records').push({ catId: newEntry.value.catId, date: newEntry.value.date, weight: inputWeight }).then(()=>{ alert('å·²è¨˜éŒ„'); newEntry.value.weight = ''; }); }
            };

            watch(currentTab, (v) => v === 'chart' && nextTick(renderChart));
            const isDatasetHidden = (i) => !!hiddenDatasets.value[i];
            const toggleDataset = (i) => { const meta = chartInstance.getDatasetMeta(i); meta.hidden = meta.hidden === null ? !chartInstance.data.datasets[i].hidden : !meta.hidden; hiddenDatasets.value[i] = meta.hidden; chartInstance.update(); };
            const renderChart = () => {
                const ctx = document.getElementById('weightChart'); if(!ctx) return;
                const allDates = [...new Set(records.value.map(r => r.date))].sort();
                const datasets = cats.value.map(cat => ({
                    label: cat.name,
                    data: allDates.map(d => records.value.filter(r => r.catId === cat.id).find(r => r.date === d)?.weight || null),
                    borderColor: cat.color, backgroundColor: cat.color, tension: 0, borderDash: [2, 2], pointRadius: 4, pointBackgroundColor: '#fff', spanGaps: true
                }));
                if(chartInstance) chartInstance.destroy();
                chartInstance = new Chart(ctx, { 
                    type: 'line', 
                    data: { labels: allDates.map(d=>d.slice(5).replace('-','.')), datasets },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } }, y: { grid: { color: '#f0f0f0' }, border: { display: false } } } } 
                });
            };

            return { 
                currentTab, cats, records, loading, healthAlert, defaultAvatar, newEntry, newCatData, isEditing, 
                editingRecordId, fileInput, getCatName, getCatAvatar, getCatColor, getSelectedCatColor, formatDate,
                triggerUpload, onFileSelect, saveCat, editCat, cancelEdit, removeCat, saveRecord, editRecord, deleteRecord, cancelRecordEdit,
                showCropper, cropper, cropImg, startDrag, onDrag, stopDrag, confirmCrop, cancelCrop, cropStyle, onImgLoad,
                historyFilter, historyPage, paginatedRecords, setHistoryFilter, totalPages, isDatasetHidden, toggleDataset
            };
        }
    }).mount('#app');
</script>
</body>
</html>
