<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>貓の體重</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@300;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* 文青配色 */
            --bg: #f9f8f6;       
            --card: #ffffff;
            --text-main: #464646;
            --text-light: #888888;
            --danger: #d68c85;   
            --border: #e8e8e6;
            --edit-color: #54a0ff;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Noto Serif TC', serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 20px 10px;
            display: flex;
            justify-content: center;
            line-height: 1.7;
        }

        .container { width: 100%; max-width: 480px; }

        h1 {
            font-weight: 700; text-align: center; margin-bottom: 30px; letter-spacing: 0.15em;
            color: var(--text-main); font-size: 1.6rem; position: relative;
        }
        h1::after {
            content: ''; display: block; width: 40px; height: 3px;
            background: #b0aaa0; margin: 10px auto 0;
        }

        .card {
            background: var(--card); padding: 30px 25px; margin-bottom: 25px;
            border: 1px solid var(--border); border-radius: 4px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.02);
        }

        /* --- UI Components --- */
        .avatar-selector { display: flex; justify-content: center; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; }
        .avatar-option {
            display: flex; flex-direction: column; align-items: center; cursor: pointer;
            opacity: 0.6; transition: all 0.4s ease;
        }
        .avatar-option.selected { opacity: 1; transform: translateY(-3px); }
        .avatar-img {
            width: 65px; height: 65px; border-radius: 50%; object-fit: cover;
            border: 3px solid #eee; padding: 2px; background: white; transition: border-color 0.3s;
        }
        .avatar-name { font-size: 0.85rem; margin-top: 8px; letter-spacing: 0.05em; color: var(--text-main); }

        .form-group { margin-bottom: 25px; }
        label { display: block; margin-bottom: 8px; font-size: 0.85rem; color: var(--text-light); letter-spacing: 0.05em; }
        input[type="text"], input[type="number"], input[type="date"] {
            width: 100%; padding: 10px 0; border: none; border-bottom: 1px solid #ccc;
            background: transparent; font-family: 'Noto Serif TC', serif; font-size: 1.1rem; 
            color: var(--text-main); border-radius: 0; outline: none; transition: border-color 0.3s;
        }
        input:focus { border-bottom-color: #666; }

        button.btn-main {
            width: 100%; padding: 15px; border: none; background-color: #666; color: white;
            font-family: 'Noto Serif TC', serif; font-size: 1rem; letter-spacing: 0.1em;
            cursor: pointer; transition: opacity 0.3s; border-radius: 2px;
        }
        button.btn-cancel {
            width: 100%; padding: 10px; border: none; background: transparent; color: #999;
            margin-top: 10px; cursor: pointer; font-size: 0.9rem;
        }
        
        .upload-area {
            border: 1px dashed #b0aaa0; padding: 20px; text-align: center; margin-top: 10px; 
            cursor: pointer; color: var(--text-light); font-size: 0.9rem; border-radius: 4px;
        }
        .preview-avatar {
            width: 100px; height: 100px; border-radius: 50%; object-fit: cover;
            margin: 15px auto; display: block; border: 4px solid #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .list-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 0; border-bottom: 1px dashed #eee;
        }
        .list-left { display: flex; align-items: center; gap: 15px; }
        .list-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .list-date { font-size: 0.75rem; color: var(--text-light); display: block; margin-bottom: 2px; }
        .list-weight { font-family: 'Noto Serif TC'; font-weight: 700; font-size: 1.1rem; }
        .list-actions { display: flex; align-items: center; gap: 5px; }

        .tabs { display: flex; justify-content: center; margin-bottom: 30px; gap: 30px; }
        .tab {
            cursor: pointer; color: var(--text-light); padding-bottom: 5px; font-size: 0.95rem; 
            letter-spacing: 0.1em; position: relative; transition: color 0.3s;
        }
        .tab.active { color: var(--text-main); font-weight: 500; }
        .tab.active::after { content: ''; position: absolute; bottom: -2px; left: 0; width: 100%; height: 1px; background: var(--text-main); }

        .chart-legend { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; cursor: pointer; opacity: 1; transition: opacity 0.3s; }
        .legend-item.hidden { opacity: 0.3; }
        .legend-avatar { width: 24px; height: 24px; border-radius: 50%; margin-right: 8px; border: 3px solid transparent; }
        .legend-text { font-size: 0.8rem; letter-spacing: 0.05em; font-weight: bold; }

        .btn-icon { background: none; border: none; color: #ccc; cursor: pointer; padding: 8px; font-size: 1rem; transition: color 0.3s; }
        .btn-icon:hover { color: var(--text-main); }
        .btn-icon.delete:hover { color: var(--danger); }
        .btn-icon.edit:hover { color: var(--edit-color); }
        
        .alert-box {
            background: #fff; border: 1px solid var(--danger); color: var(--danger);
            padding: 15px; margin-bottom: 25px; font-size: 0.9rem; display: flex; align-items: center; gap: 10px;
        }

        /* 裁切視窗樣式 */
        .crop-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .crop-area-wrapper { width: 280px; height: 280px; border: 1px solid #ddd; position: relative; overflow: hidden; background: #eee; border-radius: 4px; touch-action: none; cursor: move; box-shadow: inset 0 0 20px rgba(0,0,0,0.05); }
        .crop-mask { pointer-events: none; position: absolute; top: 0; left: 0; bottom: 0; right: 0; border-radius: 50%; box-shadow: 0 0 0 300px rgba(255,255,255,0.8); border: 2px solid #666; z-index: 10; }
        .crop-img { position: absolute; transform-origin: 0 0; max-width: none; display: block; }
        .crop-controls { width: 280px; margin-top: 25px; display: flex; flex-direction: column; gap: 15px; }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #666; cursor: pointer; margin-top: -8px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #ddd; border-radius: 2px; }
        .crop-btns { display: flex; gap: 15px; margin-top: 10px; }
        .crop-btn { flex: 1; padding: 12px; border: 1px solid var(--text-main); background: transparent; cursor: pointer; letter-spacing: 1px; font-size: 0.9rem; }
        .crop-btn.confirm { background: var(--text-main); color: white; border: none; }
    </style>
</head>
<body>

<div id="app" class="container">
    <h1>貓の體重</h1>

    <div v-if="loading" style="text-align:center; color:#999; margin-top:50px;">
        讀取中...
    </div>

    <div v-else>
        <div class="tabs">
            <div class="tab" :class="{ active: currentTab === 'record' }" @click="currentTab = 'record'">記録</div>
            <div class="tab" :class="{ active: currentTab === 'chart' }" @click="currentTab = 'chart'">趨勢</div>
            <div class="tab" :class="{ active: currentTab === 'settings' }" @click="currentTab = 'settings'">設定</div>
        </div>

        <div v-show="currentTab === 'record'">
            <div class="card">
                <div style="text-align:center; margin-bottom:15px; font-weight:bold; color:var(--edit-color);" v-if="editingRecordId">
                    正在編輯紀錄...
                </div>
                <div v-if="healthAlert" class="alert-box"><span>⚠️</span> {{ healthAlert }}</div>
                <div v-if="cats.length === 0" style="text-align:center; color:#999; padding:20px;">請先至「設定」新增貓咪</div>
                <div v-else>
                    <div class="avatar-selector">
                        <div v-for="cat in cats" :key="cat.id" 
                             class="avatar-option" :class="{ selected: newEntry.catId === cat.id }"
                             @click="newEntry.catId = cat.id">
                            <img :src="cat.avatar || defaultAvatar" class="avatar-img" 
                                 :style="{ borderColor: newEntry.catId === cat.id ? cat.color : '#eee' }">
                            <span class="avatar-name" :style="{ color: newEntry.catId === cat.id ? cat.color : '' }">{{ cat.name }}</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>日期 Date</label>
                        <input type="date" v-model="newEntry.date">
                    </div>
                    <div class="form-group">
                        <label>體重 Weight (kg)</label>
                        <input type="number" step="0.01" inputmode="decimal" v-model.number="newEntry.weight" placeholder="0.00">
                    </div>
                    
                    <button class="btn-main" @click="saveRecord" :style="{ backgroundColor: editingRecordId ? 'var(--edit-color)' : getSelectedCatColor }">
                        {{ editingRecordId ? '更新紀錄' : '儲存紀錄' }}
                    </button>
                    <button v-if="editingRecordId" class="btn-cancel" @click="cancelRecordEdit">取消編輯</button>
                </div>
            </div>
            
            <div v-if="records.length > 0">
                <div style="font-size:0.8rem; color:#aaa; text-align:center; margin-bottom:10px; letter-spacing:2px;">
                    {{ showAllHistory ? 'ALL HISTORY' : 'RECENT' }}
                </div>
                <div class="card" style="padding: 10px 25px;">
                    <div v-for="rec in displayedRecords" :key="rec.id" class="list-item">
                        <div class="list-left">
                            <img :src="getCatAvatar(rec.catId)" class="list-avatar">
                            <div>
                                <span class="list-date">{{ formatDate(rec.date) }}</span>
                                <span style="font-size:0.95rem">{{ getCatName(rec.catId) }}</span>
                            </div>
                        </div>
                        <div class="list-actions">
                            <span class="list-weight" :style="{ color: getCatColor(rec.catId), marginRight: '10px' }">{{ rec.weight }}</span>
                            <button class="btn-icon edit" @click="editRecord(rec)">✎</button>
                            <button class="btn-icon delete" @click="deleteRecord(rec.id)">✕</button>
                        </div>
                    </div>
                    <div v-if="!showAllHistory && records.length > 5" 
                         style="text-align:center; padding-top:10px; cursor:pointer; color:#999; font-size:0.85rem;"
                         @click="showAllHistory = true">▼ 查看全部歷史</div>
                    <div v-if="showAllHistory" 
                         style="text-align:center; padding-top:10px; cursor:pointer; color:#999; font-size:0.85rem;"
                         @click="showAllHistory = false">▲ 收起歷史</div>
                </div>
            </div>
        </div>

        <div v-show="currentTab === 'chart'">
            <div class="card">
                <div class="chart-legend">
                    <div v-for="(cat, index) in cats" :key="cat.id" class="legend-item" :class="{ hidden: isDatasetHidden(index) }" @click="toggleDataset(index)">
                        <img :src="cat.avatar || defaultAvatar" class="legend-avatar" :style="{ borderColor: cat.color }">
                        <span class="legend-text" :style="{ color: cat.color }">{{ cat.name }}</span>
                    </div>
                </div>
                <div style="height: 300px; width: 100%;"><canvas id="weightChart"></canvas></div>
            </div>
        </div>

        <div v-show="currentTab === 'settings'">
            <div class="card">
                <div style="text-align:center; margin-bottom:20px; font-weight:bold;">{{ isEditing ? '編輯資料' : '新增貓咪' }}</div>
                <div class="form-group" style="text-align:center;">
                    <img v-if="newCatData.avatarPreview" :src="newCatData.avatarPreview" class="preview-avatar">
                    <img v-else :src="defaultAvatar" class="preview-avatar" style="opacity:0.3;">
                    <div class="upload-area" @click="triggerUpload">{{ newCatData.avatarPreview ? '更換照片' : '點此上傳照片' }}</div>
                    <input type="file" ref="fileInput" @change="onFileSelect" accept="image/*" style="display:none;">
                </div>
                <div class="form-group">
                    <label>名字 Name</label>
                    <input type="text" v-model="newCatData.name" placeholder="輸入貓咪名字..." @keyup.enter="saveCat">
                </div>
                <button class="btn-main" @click="saveCat" :style="{background: isEditing ? '#54a0ff' : ''}">{{ isEditing ? '更新資料' : '新增貓咪' }}</button>
                <button v-if="isEditing" @click="cancelEdit" class="btn-cancel">取消編輯</button>
            </div>
            
            <div class="card" v-if="cats.length > 0" style="padding: 10px 25px;">
                <div v-for="cat in cats" :key="cat.id" class="list-item">
                    <div class="list-left">
                        <img :src="cat.avatar || defaultAvatar" class="list-avatar" :style="{ border: '2px solid ' + cat.color }">
                        <span :style="{ color: cat.color, fontWeight: 'bold' }">{{ cat.name }}</span>
                    </div>
                    <div><button class="btn-icon edit" @click="editCat(cat)">✎</button><button class="btn-icon delete" @click="removeCat(cat.id)">✕</button></div>
                </div>
            </div>
        </div>
    </div>

    <div v-if="showCropper" class="crop-modal">
        <div class="crop-area-wrapper" 
             @mousedown="startDrag" @mousemove="onDrag" @mouseup="stopDrag" @mouseleave="stopDrag"
             @touchstart="startDrag" @touchmove="onDrag" @touchend="stopDrag">
            <img ref="cropImg" :src="cropper.imgSrc" class="crop-img" :style="cropStyle" @load="onImgLoad">
            <div class="crop-mask"></div>
        </div>
        <div class="crop-controls">
            <div class="zoom-label">調整縮放與位置</div>
            <input type="range" min="0.1" max="3" step="0.05" v-model.number="cropper.userScale" class="zoom-range">
            <div class="crop-btns">
                <button class="crop-btn" @click="cancelCrop">取消</button>
                <button class="crop-btn confirm" @click="confirmCrop">完成</button>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

    // 填入你的設定
    const firebaseConfig = {
      apiKey: "AIzaSyB62SzNqiusoXCbCpDHS1vCiuS70ZHVDUE",
      authDomain: "catweight-d4888.firebaseapp.com",
      databaseURL: "https://catweight-d4888-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "catweight-d4888",
      storageBucket: "catweight-d4888.firebasestorage.app",
      messagingSenderId: "527733046362",
      appId: "1:527733046362:web:d1bd552108e6c03f8d6c63"
    };

    // 初始化 Firebase (使用 Compat 語法)
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();

    createApp({
        setup() {
            const currentTab = ref('record');
            const cats = ref([]);
            const records = ref([]);
            const loading = ref(true);
            const healthAlert = ref('');
            const fileInput = ref(null);
            const defaultAvatar = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23e0e0e0'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z'/%3E%3C/svg%3E";

            const newEntry = ref({ catId: '', date: new Date().toISOString().split('T')[0], weight: '' });
            const editingRecordId = ref(null);
            const showAllHistory = ref(false);

            const newCatData = ref({ name: '', avatarPreview: null, avatarBase64: null });
            const editingCatId = ref(null);
            const isEditing = computed(() => editingCatId.value !== null);
            const hiddenDatasets = ref({});
            let chartInstance = null;

            const colors = ['#3498db', '#e67e22', '#2ecc71', '#9b59b6', '#e74c3c', '#1abc9c', '#f1c40f'];
            const showCropper = ref(false);
            const cropImg = ref(null);
            const cropper = ref({ imgSrc: '', baseScale: 1, userScale: 1, x: 0, y: 0, isDragging: false, startX: 0, startY: 0, lastX: 0, lastY: 0 });

            onMounted(() => {
                db.ref('cats').on('value', (snapshot) => {
                    const data = snapshot.val();
                    cats.value = data ? Object.entries(data).map(([key, val]) => ({ id: key, ...val })) : [];
                    if (cats.value.length && !newEntry.value.catId && !editingRecordId.value) newEntry.value.catId = cats.value[0].id;
                    loading.value = false;
                    if(currentTab.value === 'chart') renderChart();
                });

                db.ref('records').on('value', (snapshot) => {
                    const data = snapshot.val();
                    records.value = data ? Object.entries(data).map(([key, val]) => ({ id: key, ...val })) : [];
                    records.value.sort((a, b) => new Date(a.date) - new Date(b.date));
                    if(currentTab.value === 'chart') renderChart();
                });
            });

            // --- Record Logic ---
            const editRecord = (rec) => {
                editingRecordId.value = rec.id;
                newEntry.value = { catId: rec.catId, date: rec.date, weight: rec.weight };
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const cancelRecordEdit = () => {
                editingRecordId.value = null;
                newEntry.value = { catId: cats.value.length ? cats.value[0].id : '', date: new Date().toISOString().split('T')[0], weight: '' };
                healthAlert.value = '';
            };

            const deleteRecord = (id) => {
                if(confirm('確定要刪除這筆紀錄嗎？')) {
                    db.ref(`records/${id}`).remove();
                    if(editingRecordId.value === id) cancelRecordEdit();
                }
            };

            const saveRecord = () => {
                if(!newEntry.value.catId || !newEntry.value.weight) return alert('資料不全');
                
                const inputDate = new Date(newEntry.value.date);
                const inputWeight = parseFloat(newEntry.value.weight);

                const catRecs = records.value
                    .filter(r => r.catId === newEntry.value.catId && r.id !== editingRecordId.value)
                    .sort((a, b) => new Date(a.date) - new Date(b.date));

                if(catRecs.length > 0) {
                    const lastRecord = catRecs[catRecs.length - 1];
                    const lastDate = new Date(lastRecord.date);
                    if (inputDate >= lastDate) {
                        const lastWeight = lastRecord.weight;
                        const diff = inputWeight - lastWeight;
                        if(Math.abs(diff)/lastWeight >= 0.05) {
                            healthAlert.value = `注意：${getCatName(newEntry.value.catId)} 體重變化 ${(diff>0?'+':'')}${diff.toFixed(2)}kg`;
                        } else {
                            healthAlert.value = '';
                        }
                    } else {
                        healthAlert.value = '';
                    }
                }

                if (editingRecordId.value) {
                    db.ref(`records/${editingRecordId.value}`).update({
                        catId: newEntry.value.catId,
                        date: newEntry.value.date,
                        weight: inputWeight
                    }).then(() => { alert('紀錄已更新'); cancelRecordEdit(); });
                } else {
                    db.ref('records').push({ 
                        catId: newEntry.value.catId, 
                        date: newEntry.value.date, 
                        weight: inputWeight 
                    }).then(() => { alert('已記錄'); newEntry.value.weight = ''; });
                }
            };

            const displayedRecords = computed(() => {
                const sorted = [...records.value].sort((a,b) => new Date(b.date) - new Date(a.date));
                if (showAllHistory.value) return sorted;
                return sorted.slice(0, 5);
            });

            // --- Other Logic ---
            const triggerUpload = () => fileInput.value.click();
            const onFileSelect = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    cropper.value = { imgSrc: evt.target.result, baseScale: 1, userScale: 1, x: 0, y: 0, isDragging: false, startX: 0, startY: 0, lastX: 0, lastY: 0 };
                    showCropper.value = true; e.target.value = '';
                };
                reader.readAsDataURL(file);
            };
            const onImgLoad = (e) => {
                const img = e.target;
                const viewportSize = 280;
                const ratio = viewportSize / Math.min(img.naturalWidth, img.naturalHeight);
                cropper.value.baseScale = ratio; cropper.value.userScale = 1; 
                cropper.value.x = (viewportSize - img.naturalWidth * ratio) / 2;
                cropper.value.y = (viewportSize - img.naturalHeight * ratio) / 2;
                cropper.value.lastX = cropper.value.x; cropper.value.lastY = cropper.value.y;
            };
            const finalScale = computed(() => cropper.value.baseScale * cropper.value.userScale);
            const cropStyle = computed(() => ({ transform: `translate(${cropper.value.x}px, ${cropper.value.y}px) scale(${finalScale.value})` }));
            
            const getClientPos = (e) => e.touches ? { x: e.touches[0].clientX, y: e.touches[0].clientY } : { x: e.clientX, y: e.clientY };
            const startDrag = (e) => { cropper.value.isDragging = true; const pos = getClientPos(e); cropper.value.startX = pos.x; cropper.value.startY = pos.y; };
            const onDrag = (e) => { if (!cropper.value.isDragging) return; e.preventDefault(); const pos = getClientPos(e); cropper.value.x = cropper.value.lastX + (pos.x - cropper.value.startX); cropper.value.y = cropper.value.lastY + (pos.y - cropper.value.startY); };
            const stopDrag = () => { cropper.value.isDragging = false; cropper.value.lastX = cropper.value.x; cropper.value.lastY = cropper.value.y; };
            const confirmCrop = () => {
                const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                const size = 200; canvas.width = size; canvas.height = size;
                ctx.fillStyle = "#fff"; ctx.fillRect(0, 0, size, size);
                const ratio = size / 280; 
                ctx.save(); ctx.scale(ratio, ratio); ctx.translate(cropper.value.x, cropper.value.y); ctx.scale(finalScale.value, finalScale.value);
                ctx.drawImage(cropImg.value, 0, 0); ctx.restore();
                const dataUrl = canvas.toDataURL('image/jpeg', 0.85);
                newCatData.value.avatarPreview = dataUrl; newCatData.value.avatarBase64 = dataUrl;
                showCropper.value = false;
            };
            const cancelCrop = () => showCropper.value = false;

            const getCatName = (id) => cats.value.find(c => c.id === id)?.name;
            const getCatAvatar = (id) => cats.value.find(c => c.id === id)?.avatar || defaultAvatar;
            const getCatColor = (id) => cats.value.find(c => c.id === id)?.color || '#ccc';
            const getSelectedCatColor = computed(() => getCatColor(newEntry.value.catId));
            const formatDate = (s) => s.replace(/-/g, '.');

            const editCat = (cat) => { editingCatId.value = cat.id; newCatData.value = { name: cat.name, avatarPreview: cat.avatar, avatarBase64: cat.avatar }; window.scrollTo({ top: 0, behavior: 'smooth' }); };
            const cancelEdit = () => { editingCatId.value = null; newCatData.value = { name: '', avatarPreview: null, avatarBase64: null }; };
            const saveCat = () => {
                if(!newCatData.value.name.trim()) return alert('請輸入名字');
                const payload = { name: newCatData.value.name, avatar: newCatData.value.avatarBase64 || null };
                if(isEditing.value) db.ref(`cats/${editingCatId.value}`).update(payload).then(()=>{ cancelEdit(); alert('已更新'); });
                else { payload.color = colors[cats.value.length % colors.length]; db.ref('cats').push(payload).then(()=>{ cancelEdit(); alert('已新增'); }); }
            };
            const removeCat = (id) => confirm('刪除後無法復原，確定？') && db.ref(`cats/${id}`).remove();

            watch(currentTab, (v) => v === 'chart' && nextTick(renderChart));
            const isDatasetHidden = (i) => !!hiddenDatasets.value[i];
            const toggleDataset = (i) => { const meta = chartInstance.getDatasetMeta(i); meta.hidden = meta.hidden === null ? !chartInstance.data.datasets[i].hidden : !meta.hidden; hiddenDatasets.value[i] = meta.hidden; chartInstance.update(); };
            const renderChart = () => {
                const ctx = document.getElementById('weightChart'); if(!ctx) return;
                const allDates = [...new Set(records.value.map(r => r.date))].sort();
                const datasets = cats.value.map(cat => ({
                    label: cat.name, data: allDates.map(d => records.value.filter(r => r.catId === cat.id).find(r => r.date === d)?.weight || null),
                    borderColor: cat.color, backgroundColor: cat.color, tension: 0, borderDash: [2, 2], pointRadius: 4, pointBackgroundColor: '#fff', spanGaps: true
                }));
                if(chartInstance) chartInstance.destroy();
                chartInstance = new Chart(ctx, { type: 'line', data: { labels: allDates.map(d=>d.slice(5).replace('-','.')), datasets }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } }, y: { grid: { color: '#f0f0f0' }, border: { display: false } } } } });
                hiddenDatasets.value = {};
            };

            return { 
                currentTab, cats, displayedRecords, newEntry, newCatData, isEditing, loading, healthAlert, defaultAvatar,
                saveRecord, editRecord, deleteRecord, cancelRecordEdit, editingRecordId, showAllHistory,
                saveCat, editCat, cancelEdit, removeCat, getCatName, getCatAvatar, formatDate, getCatColor, getSelectedCatColor,
                triggerUpload, fileInput, onFileSelect, showCropper, cropper, cropImg, startDrag, onDrag, stopDrag, confirmCrop, cancelCrop, cropStyle, onImgLoad,
                isDatasetHidden, toggleDataset
            };
        }
    }).mount('#app');
</script>
</body>
</html>
