<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>貓の體重</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <script>window.onerror = function(msg, url, line) { console.error("錯誤:", msg); };</script>

    <style>
        :root {
            --bg: #f9f8f6;       
            --card: #ffffff;
            --text-main: #464646;
            --text-light: #888888;
            --primary: #78866b;
            --danger: #d68c85;
            --border: #e8e8e6;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Noto Serif TC', serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 20px 10px;
            display: flex;
            justify-content: center;
            line-height: 1.6;
        }

        .container { width: 100%; max-width: 480px; }

        h1 {
            font-weight: 700; text-align: center; margin-bottom: 25px; letter-spacing: 0.1em;
            color: var(--text-main); font-size: 1.5rem; position: relative;
        }
        h1::after {
            content: ''; display: block; width: 30px; height: 2px;
            background: #b0aaa0; margin: 8px auto 0;
        }

        .card {
            background: var(--card); padding: 25px; margin-bottom: 20px;
            border: 1px solid var(--border); border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.03);
        }

        /* Loading */
        .loading-box { text-align: center; color: #999; margin-top: 50px; font-size: 0.9rem; }

        /* --- 圓形大頭貼 --- */
        .avatar-selector { display: flex; justify-content: center; gap: 18px; margin-bottom: 25px; flex-wrap: wrap; }
        .avatar-option { display: flex; flex-direction: column; align-items: center; cursor: pointer; opacity: 0.5; transition: all 0.3s ease; }
        .avatar-option.selected { opacity: 1; transform: translateY(-3px); }
        .avatar-img {
            width: 65px; height: 65px; border-radius: 50%; object-fit: cover; 
            border: 3px solid #eee; padding: 2px; background: white; 
            transition: border-color 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .avatar-name { font-size: 0.85rem; margin-top: 8px; letter-spacing: 0.05em; font-weight: bold; }

        /* 輸入框 */
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 6px; font-size: 0.8rem; color: var(--text-light); letter-spacing: 0.05em; }
        input[type="text"], input[type="number"], input[type="date"] {
            width: 100%; padding: 12px 0; border: none; border-bottom: 1px solid #ccc;
            background: transparent; font-family: 'Noto Serif TC', serif; font-size: 1.1rem; 
            color: var(--text-main); border-radius: 0; outline: none; transition: border-color 0.3s;
        }
        input:focus { border-bottom-color: var(--primary); }

        button.btn-main {
            width: 100%; padding: 14px; border: none; background-color: var(--primary); color: white;
            font-family: 'Noto Serif TC', serif; font-size: 1rem; letter-spacing: 0.1em;
            cursor: pointer; transition: opacity 0.3s; border-radius: 8px; margin-top: 10px;
        }
        button.btn-cancel {
            width: 100%; padding: 10px; border: none; background: transparent; color: #999;
            margin-top: 5px; cursor: pointer; font-size: 0.85rem;
        }
        
        .upload-area {
            border: 1px dashed #b0aaa0; padding: 20px; text-align: center; margin-top: 10px; 
            cursor: pointer; color: var(--text-light); font-size: 0.85rem; border-radius: 8px;
        }
        .preview-avatar { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin: 15px auto; display: block; border: 4px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        /* 列表樣式 */
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px dashed #eee; }
        .list-left { display: flex; align-items: center; gap: 15px; }
        .list-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid #eee; }
        .list-date { font-size: 0.8rem; color: var(--text-light); display: block; margin-bottom: 2px; }
        .list-weight { font-family: 'Noto Serif TC'; font-weight: 700; font-size: 1.1rem; }
        
        /* 歷史紀錄分類 Filter */
        .history-filters { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 15px; border-bottom: 1px solid #eee; }
        .filter-chip { 
            white-space: nowrap; padding: 6px 14px; border-radius: 20px; background: #f0f0f0; 
            color: #666; font-size: 0.85rem; cursor: pointer; transition: all 0.3s; border: 1px solid transparent;
        }
        .filter-chip.active { background: var(--text-main); color: white; }
        
        /* 分頁按鈕 */
        .pagination { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding-top: 10px; border-top: 1px solid #eee; }
        .page-btn { background: none; border: 1px solid #ddd; padding: 5px 12px; border-radius: 4px; font-size: 0.8rem; cursor: pointer; }
        .page-btn:disabled { opacity: 0.3; cursor: not-allowed; }

        /* Tab */
        .tabs { display: flex; justify-content: center; margin-bottom: 30px; gap: 25px; }
        .tab { cursor: pointer; color: var(--text-light); padding-bottom: 5px; font-size: 0.95rem; letter-spacing: 0.1em; position: relative; transition: color 0.3s; }
        .tab.active { color: var(--text-main); font-weight: bold; }
        .tab.active::after { content: ''; position: absolute; bottom: -2px; left: 0; width: 100%; height: 2px; background: var(--primary); }

        .btn-icon { background: none; border: none; color: #ccc; cursor: pointer; padding: 8px; font-size: 1.1rem; }
        .alert-box { background: #fff; border: 1px solid var(--danger); color: var(--danger); padding: 12px; margin-bottom: 20px; font-size: 0.85rem; display: flex; align-items: center; gap: 10px; border-radius: 4px; }

        /* --- 修正後的圖表圖例 (Legend) --- */
        .chart-legend-container {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; 
            margin-bottom: 20px; padding: 10px; background: #fcfcfc; border-radius: 8px;
        }
        .legend-pill {
            display: flex; align-items: center; background: white; 
            padding: 5px 12px 5px 5px; border-radius: 30px; 
            box-shadow: 0 2px 6px rgba(0,0,0,0.08); cursor: pointer;
            transition: all 0.2s; border: 1px solid transparent;
        }
        .legend-pill.hidden { opacity: 0.4; box-shadow: none; background: #eee; }
        .legend-avatar { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; margin-right: 8px; }
        .legend-name { font-size: 0.85rem; font-weight: bold; letter-spacing: 0.05em; color: #555; }

        /* 裁切視窗 */
        .crop-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .crop-area-wrapper { width: 280px; height: 280px; border: 1px solid #ddd; position: relative; overflow: hidden; background: #eee; border-radius: 4px; touch-action: none; cursor: move; box-shadow: inset 0 0 20px rgba(0,0,0,0.05); }
        .crop-mask { pointer-events: none; position: absolute; top: 0; left: 0; bottom: 0; right: 0; border-radius: 50%; box-shadow: 0 0 0 300px rgba(255,255,255,0.8); border: 2px solid #666; z-index: 10; }
        .crop-img { position: absolute; transform-origin: 0 0; max-width: none; display: block; }
        .crop-controls { width: 280px; margin-top: 25px; display: flex; flex-direction: column; gap: 15px; }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #666; cursor: pointer; margin-top: -8px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #ddd; border-radius: 2px; }
        .crop-btns { display: flex; gap: 15px; margin-top: 10px; }
        .crop-btn { flex: 1; padding: 12px; border: 1px solid var(--text-main); background: transparent; cursor: pointer; letter-spacing: 1px; font-size: 0.9rem; }
        .crop-btn.confirm { background: var(--text-main); color: white; border: none; }
    </style>
</head>
<body>

<div id="app" class="container">
    <h1>貓の體重</h1>

    <div v-if="loading" class="loading-box">讀取中...<br><small>連線中</small></div>

    <div v-else>
        <div class="tabs">
            <div class="tab" :class="{ active: currentTab === 'record' }" @click="currentTab = 'record'">記録</div>
            <div class="tab" :class="{ active: currentTab === 'chart' }" @click="currentTab = 'chart'">趨勢</div>
            <div class="tab" :class="{ active: currentTab === 'settings' }" @click="currentTab = 'settings'">設定</div>
        </div>

        <div v-show="currentTab === 'record'">
            <div class="card">
                <div style="text-align:center; margin-bottom:15px; font-weight:bold; color:var(--edit-color);" v-if="editingRecordId">✎ 編輯模式</div>
                <div v-if="healthAlert" class="alert-box"><span>⚠️</span> {{ healthAlert }}</div>
                
                <div v-if="cats.length === 0" style="text-align:center; color:#999; padding:20px;">請先至「設定」新增貓咪</div>
                <div v-else>
                    <div class="avatar-selector">
                        <div v-for="cat in cats" :key="cat.id" 
                             class="avatar-option" :class="{ selected: newEntry.catId === cat.id }"
                             @click="newEntry.catId = cat.id">
                            <img :src="cat.avatar || defaultAvatar" class="avatar-img" 
                                 :style="{ borderColor: newEntry.catId === cat.id ? cat.color : '#eee' }">
                            <span class="avatar-name" :style="{ color: newEntry.catId === cat.id ? cat.color : '' }">{{ cat.name }}</span>
                        </div>
                    </div>
                    <div class="form-group"><label>日期 Date</label><input type="date" v-model="newEntry.date"></div>
                    <div class="form-group"><label>體重 Weight (kg)</label><input type="number" step="0.01" inputmode="decimal" v-model.number="newEntry.weight" placeholder="0.00"></div>
                    
                    <button class="btn-main" @click="saveRecord" :style="{ backgroundColor: editingRecordId ? '#54a0ff' : getSelectedCatColor }">
                        {{ editingRecordId ? '更新紀錄' : '儲存紀錄' }}
                    </button>
                    <button v-if="editingRecordId" class="btn-cancel" @click="cancelRecordEdit">取消編輯</button>
                </div>
            </div>
            
            <div v-if="records.length > 0">
                <div style="font-size:0.75rem; color:#aaa; text-align:center; margin-bottom:10px; letter-spacing:1px;">HISTORY</div>
                
                <div class="card" style="padding: 15px;">
                    <div class="history-filters">
                        <div class="filter-chip" :class="{active: historyFilter === 'all'}" @click="setHistoryFilter('all')">全部</div>
                        <div v-for="cat in cats" :key="cat.id" 
                             class="filter-chip" :class="{active: historyFilter === cat.id}" 
                             @click="setHistoryFilter(cat.id)">
                            {{ cat.name }}
                        </div>
                    </div>

                    <div v-if="paginatedRecords.length === 0" style="text-align:center; padding:20px; color:#ccc;">無紀錄</div>
                    <div v-for="rec in paginatedRecords" :key="rec.id" class="list-item">
                        <div class="list-left">
                            <img :src="getCatAvatar(rec.catId)" class="list-avatar">
                            <div>
                                <span class="list-date">{{ formatDate(rec.date) }}</span>
                                <span style="font-size:0.9rem; font-weight:bold; color:#555;">{{ getCatName(rec.catId) }}</span>
                            </div>
                        </div>
                        <div class="list-actions">
                            <span class="list-weight" :style="{ color: getCatColor(rec.catId) }">{{ rec.weight }}</span>
                            <button class="btn-icon" @click="editRecord(rec)">✎</button>
                            <button class="btn-icon" @click="deleteRecord(rec.id)">✕</button>
                        </div>
                    </div>

                    <div class="pagination" v-if="totalPages > 1">
                        <button class="page-btn" :disabled="historyPage === 1" @click="historyPage--">← 上一頁</button>
                        <span style="font-size:0.8rem; color:#888;">{{ historyPage }} / {{ totalPages }}</span>
                        <button class="page-btn" :disabled="historyPage === totalPages" @click="historyPage++">下一頁 →</button>
                    </div>
                </div>
            </div>
        </div>

        <div v-show="currentTab === 'chart'">
            <div class="card">
                <div class="chart-legend-container">
                    <div v-for="(cat, index) in cats" :key="cat.id" 
                         class="legend-pill" :class="{ hidden: isDatasetHidden(index) }"
                         @click="toggleDataset(index)">
                        <img :src="cat.avatar || defaultAvatar" class="legend-avatar" :style="{ borderColor: cat.color }">
                        <span class="legend-name">{{ cat.name }}</span>
                    </div>
                </div>
                
                <div style="height: 300px; width: 100%;"><canvas id="weightChart"></canvas></div>
            </div>
        </div>

        <div v-show="currentTab === 'settings'">
            <div class="card">
                <div style="text-align:center; margin-bottom:20px; font-weight:bold;">{{ isEditing ? '編輯資料' : '新增貓咪' }}</div>
                <div class="form-group" style="text-align:center;">
                    <img v-if="newCatData.avatarPreview" :src="newCatData.avatarPreview" class="preview-avatar">
                    <img v-else :src="defaultAvatar" class="preview-avatar" style="opacity:0.3;">
                    <div class="upload-area" @click="triggerUpload">{{ newCatData.avatarPreview ? '更換照片' : '點此上傳照片' }}</div>
                    <input type="file" ref="fileInput" @change="onFileSelect" accept="image/*" style="display:none;">
                </div>
                <div class="form-group"><label>名字 Name</label><input type="text" v-model="newCatData.name" placeholder="輸入貓咪名字..." @keyup.enter="saveCat"></div>
                <button class="btn-main" @click="saveCat" :style="{background: isEditing ? '#54a0ff' : ''}">{{ isEditing ? '更新資料' : '新增貓咪' }}</button>
                <button v-if="isEditing" @click="cancelEdit" class="btn-cancel">取消編輯</button>
            </div>
            
            <div class="card" v-if="cats.length > 0" style="padding: 10px 20px;">
                <div v-for="cat in cats" :key="cat.id" class="list-item">
                    <div class="list-left">
                        <img :src="cat.avatar || defaultAvatar" class="list-avatar" :style="{ border: '2px solid ' + cat.color }">
                        <span style="font-weight:bold; color:#555;">{{ cat.name }}</span>
                    </div>
                    <div><button class="btn-icon" @click="editCat(cat)">✎</button><button class="btn-icon" @click="removeCat(cat.id)">✕</button></div>
                </div>
            </div>
        </div>
    </div>

    <div v-if="showCropper" class="crop-modal">
        <div class="crop-area-wrapper" 
             @mousedown="startDrag" @mousemove="onDrag" @mouseup="stopDrag" @mouseleave="stopDrag"
             @touchstart="startDrag" @touchmove="onDrag" @touchend="stopDrag">
            <img ref="cropImg" :src="cropper.imgSrc" class="crop-img" :style="cropStyle" @load="onImgLoad">
            <div class="crop-mask"></div>
        </div>
        <div class="crop-controls">
            <div class="zoom-label">調整縮放與位置</div>
            <input type="range" min="0.1" max="3" step="0.05" v-model.number="cropper.userScale" class="zoom-range">
            <div class="crop-btns">
                <button class="crop-btn" @click="cancelCrop">取消</button>
                <button class="crop-btn confirm" @click="confirmCrop">完成</button>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

    const firebaseConfig = {
      apiKey: "AIzaSyB62SzNqiusoXCbCpDHS1vCiuS70ZHVDUE",
      authDomain: "catweight-d4888.firebaseapp.com",
      databaseURL: "https://catweight-d4888-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "catweight-d4888",
      storageBucket: "catweight-d4888.firebasestorage.app",
      messagingSenderId: "527733046362",
      appId: "1:527733046362:web:d1bd552108e6c03f8d6c63"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    createApp({
        setup() {
            const currentTab = ref('record');
            const cats = ref([]);
            const records = ref([]);
            const loading = ref(true);
            const healthAlert = ref('');
            const fileInput = ref(null);
            const defaultAvatar = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23e0e0e0'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z'/%3E%3C/svg%3E";

            const newEntry = ref({ catId: '', date: new Date().toISOString().split('T')[0], weight: '' });
            const editingRecordId = ref(null);
            
            // 分頁與篩選相關 State
            const historyFilter = ref('all');
            const historyPage = ref(1);
            const itemsPerPage = 5;

            const newCatData = ref({ name: '', avatarPreview: null, avatarBase64: null });
            const editingCatId = ref(null);
            const isEditing = computed(() => editingCatId.value !== null);
            const hiddenDatasets = ref({});
            let chartInstance = null;

            const colors = ['#3498db', '#e67e22', '#2ecc71', '#9b59b6', '#e74c3c', '#1abc9c', '#f1c40f'];
            const showCropper = ref(false);
            const cropImg = ref(null);
            const cropper = ref({ imgSrc: '', baseScale: 1, userScale: 1, x: 0, y: 0, isDragging: false, startX: 0, startY: 0, lastX: 0, lastY: 0 });

            setTimeout(() => { if(loading.value) loading.value = false; }, 3000);

            onMounted(() => {
                db.ref('cats').on('value', snap => {
                    const val = snap.val();
                    cats.value = val ? Object.entries(val).map(([k,v]) => ({id:k, ...v})) : [];
                    if(cats.value.length && !newEntry.value.catId && !editingRecordId.value) newEntry.value.catId = cats.value[0].id;
                    loading.value = false;
                    if(currentTab.value === 'chart') renderChart();
                });
                db.ref('records').on('value', snap => {
                    const val = snap.val();
                    records.value = val ? Object.entries(val).map(([k,v]) => ({id:k, ...v})).sort((a,b)=>new Date(a.date)-new Date(b.date)) : [];
                    if(currentTab.value === 'chart') renderChart();
                });
            });

            // 歷史紀錄篩選與分頁邏輯
            const setHistoryFilter = (id) => {
                historyFilter.value = id;
                historyPage.value = 1; // 切換篩選時回到第一頁
            };

            const filteredRecords = computed(() => {
                let sorted = [...records.value].sort((a,b) => new Date(b.date) - new Date(a.date)); // 日期新->舊
                if (historyFilter.value !== 'all') {
                    sorted = sorted.filter(r => r.catId === historyFilter.value);
                }
                return sorted;
            });

            const totalPages = computed(() => Math.ceil(filteredRecords.value.length / itemsPerPage));

            const paginatedRecords = computed(() => {
                const start = (historyPage.value - 1) * itemsPerPage;
                const end = start + itemsPerPage;
                return filteredRecords.value.slice(start, end);
            });

            const triggerUpload = () => fileInput.value.click();
            const onFileSelect = (e) => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (evt) => { cropper.value = { imgSrc: evt.target.result, baseScale: 1, userScale: 1, x: 0, y: 0, isDragging: false, startX: 0, startY: 0, lastX: 0, lastY: 0 }; showCropper.value = true; e.target.value = ''; }; reader.readAsDataURL(file); };
            const onImgLoad = (e) => { const img = e.target; const ratio = 280 / Math.min(img.naturalWidth, img.naturalHeight); cropper.value.baseScale = ratio; cropper.value.userScale = 1; cropper.value.x = (280 - img.naturalWidth * ratio) / 2; cropper.value.y = (280 - img.naturalHeight * ratio) / 2; cropper.value.lastX = cropper.value.x; cropper.value.lastY = cropper.value.y; };
            const finalScale = computed(() => cropper.value.baseScale * cropper.value.userScale);
            const cropStyle = computed(() => ({ transform: `translate(${cropper.value.x}px, ${cropper.value.y}px) scale(${finalScale.value})` }));
            const getClientPos = (e) => e.touches ? { x: e.touches[0].clientX, y: e.touches[0].clientY } : { x: e.clientX, y: e.clientY };
            const startDrag = (e) => { cropper.value.isDragging = true; const pos = getClientPos(e); cropper.value.startX = pos.x; cropper.value.startY = pos.y; };
            const onDrag = (e) => { if (!cropper.value.isDragging) return; e.preventDefault(); const pos = getClientPos(e); cropper.value.x = cropper.value.lastX + (pos.x - cropper.value.startX); cropper.value.y = cropper.value.lastY + (pos.y - cropper.value.startY); };
            const stopDrag = () => { cropper.value.isDragging = false; cropper.value.lastX = cropper.value.x; cropper.value.lastY = cropper.value.y; };
            const confirmCrop = () => { const cvs = document.createElement('canvas'); const ctx = cvs.getContext('2d'); cvs.width = 200; cvs.height = 200; ctx.fillStyle = "#fff"; ctx.fillRect(0, 0, 200, 200); const ratio = 200/280; ctx.save(); ctx.scale(ratio, ratio); ctx.translate(cropper.value.x, cropper.value.y); ctx.scale(finalScale.value, finalScale.value); ctx.drawImage(cropImg.value, 0, 0); ctx.restore(); newCatData.value.avatarPreview = cvs.toDataURL('image/jpeg', 0.85); newCatData.value.avatarBase64 = newCatData.value.avatarPreview; showCropper.value = false; };
            const cancelCrop = () => showCropper.value = false;
            
            const getCatName = (id) => cats.value.find(c => c.id === id)?.name;
            const getCatAvatar = (id) => cats.value.find(c => c.id === id)?.avatar || defaultAvatar;
            const getCatColor = (id) => cats.value.find(c => c.id === id)?.color || '#ccc';
            const getSelectedCatColor = computed(() => getCatColor(newEntry.value.catId));
            const formatDate = (s) => s.replace(/-/g, '.');

            const editCat = (cat) => { editingCatId.value = cat.id; newCatData.value = { name: cat.name, avatarPreview: cat.avatar, avatarBase64: cat.avatar }; window.scrollTo({ top: 0, behavior: 'smooth' }); };
            const cancelEdit = () => { editingCatId.value = null; newCatData.value = { name: '', avatarPreview: null, avatarBase64: null }; };
            const saveCat = () => { if(!newCatData.value.name.trim()) return alert('請輸入名字'); const payload = { name: newCatData.value.name, avatar: newCatData.value.avatarBase64 || null }; if(isEditing.value) db.ref(`cats/${editingCatId.value}`).update(payload).then(()=>{ cancelEdit(); alert('已更新'); }); else { payload.color = colors[cats.value.length % colors.length]; db.ref('cats').push(payload).then(()=>{ cancelEdit(); alert('已新增'); }); } };
            const removeCat = (id) => confirm('刪除後無法復原，確定？') && db.ref(`cats/${id}`).remove();

            const editRecord = (rec) => { editingRecordId.value = rec.id; newEntry.value = { catId: rec.catId, date: rec.date, weight: rec.weight }; window.scrollTo({ top: 0, behavior: 'smooth' }); };
            const cancelRecordEdit = () => { editingRecordId.value = null; newEntry.value = { catId: cats.value.length ? cats.value[0].id : '', date: new Date().toISOString().split('T')[0], weight: '' }; healthAlert.value = ''; };
            const deleteRecord = (id) => confirm('刪除此紀錄？') && db.ref(`records/${id}`).remove();
            
            const saveRecord = () => {
                if(!newEntry.value.catId || !newEntry.value.weight) return alert('資料不全');
                const inputDate = new Date(newEntry.value.date);
                const inputWeight = parseFloat(newEntry.value.weight);
                const catRecs = records.value.filter(r => r.catId === newEntry.value.catId && r.id !== editingRecordId.value).sort((a, b) => new Date(a.date) - new Date(b.date));
                if(catRecs.length > 0) {
                    const last = catRecs[catRecs.length - 1];
                    if (inputDate >= new Date(last.date)) {
                        const diff = inputWeight - last.weight;
                        healthAlert.value = (Math.abs(diff)/last.weight >= 0.05) ? `注意：${getCatName(newEntry.value.catId)} 體重變化 ${(diff>0?'+':'')}${diff.toFixed(2)}kg` : '';
                    } else healthAlert.value = '';
                }
                if (editingRecordId.value) { db.ref(`records/${editingRecordId.value}`).update({ catId: newEntry.value.catId, date: newEntry.value.date, weight: inputWeight }).then(()=>{ alert('已更新'); cancelRecordEdit(); }); }
                else { db.ref('records').push({ catId: newEntry.value.catId, date: newEntry.value.date, weight: inputWeight }).then(()=>{ alert('已記錄'); newEntry.value.weight = ''; }); }
            };

            watch(currentTab, (v) => v === 'chart' && nextTick(renderChart));
            const isDatasetHidden = (i) => !!hiddenDatasets.value[i];
            const toggleDataset = (i) => { const meta = chartInstance.getDatasetMeta(i); meta.hidden = meta.hidden === null ? !chartInstance.data.datasets[i].hidden : !meta.hidden; hiddenDatasets.value[i] = meta.hidden; chartInstance.update(); };
            const renderChart = () => {
                const ctx = document.getElementById('weightChart'); if(!ctx) return;
                const allDates = [...new Set(records.value.map(r => r.date))].sort();
                const datasets = cats.value.map(cat => ({
                    label: cat.name,
                    data: allDates.map(d => records.value.filter(r => r.catId === cat.id).find(r => r.date === d)?.weight || null),
                    borderColor: cat.color, backgroundColor: cat.color, tension: 0, borderDash: [2, 2], pointRadius: 4, pointBackgroundColor: '#fff', spanGaps: true
                }));
                if(chartInstance) chartInstance.destroy();
                chartInstance = new Chart(ctx, { 
                    type: 'line', 
                    data: { labels: allDates.map(d=>d.slice(5).replace('-','.')), datasets },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false } }, y: { grid: { color: '#f0f0f0' }, border: { display: false } } } } 
                });
            };

            return { 
                currentTab, cats, records, loading, healthAlert, defaultAvatar, newEntry, newCatData, isEditing, 
                editingRecordId, fileInput, getCatName, getCatAvatar, getCatColor, getSelectedCatColor, formatDate,
                triggerUpload, onFileSelect, saveCat, editCat, cancelEdit, removeCat, saveRecord, editRecord, deleteRecord, cancelRecordEdit,
                showCropper, cropper, cropImg, startDrag, onDrag, stopDrag, confirmCrop, cancelCrop, cropStyle, onImgLoad,
                historyFilter, historyPage, paginatedRecords, setHistoryFilter, totalPages, isDatasetHidden, toggleDataset
            };
        }
    }).mount('#app');
</script>
</body>
</html>
